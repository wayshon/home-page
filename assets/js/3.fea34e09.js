(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{177:function(t,e,a){t.exports=a.p+"assets/img/flow.32cf13ac.png"},178:function(t,e,a){t.exports=a.p+"assets/img/infoplist.caa59ab4.png"},179:function(t,e,a){t.exports=a.p+"assets/img/flutter_oc_value.89fb82e0.png"},180:function(t,e,a){t.exports=a.p+"assets/img/why.b079817b.png"},181:function(t,e,a){t.exports=a.p+"assets/img/demo1.93d008ad.png"},182:function(t,e,a){t.exports=a.p+"assets/img/demo2.d3783a00.png"},183:function(t,e,a){t.exports=a.p+"assets/img/ok.abf87c44.png"},184:function(t,e,a){t.exports=a.p+"assets/img/chiliu.5b6a2408.png"},185:function(t,e,a){t.exports=a.p+"assets/img/cry.a06d963c.png"},186:function(t,e,a){t.exports=a.p+"assets/img/smile.74ef0e9c.png"},241:function(t,e,a){"use strict";a.r(e);var s=[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"基于flutter的hybrid-webview容器实践"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基于flutter的hybrid-webview容器实践","aria-hidden":"true"}},[this._v("#")]),this._v(" 基于Flutter的Hybrid Webview容器实践")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#背景","aria-hidden":"true"}},[this._v("#")]),this._v(" 背景")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("strong",[this._v("目标: Flutter 中嵌入 webview widget，这个 webview 需要受 flutter 控制，且能够与 flutter 通信。")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#思路","aria-hidden":"true"}},[this._v("#")]),this._v(" 思路")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:a(177),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"具体实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#具体实现","aria-hidden":"true"}},[this._v("#")]),this._v(" 具体实现")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"target-1-实现-webview-插件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#target-1-实现-webview-插件","aria-hidden":"true"}},[this._v("#")]),this._v(" target 1: 实现 webview 插件")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("flutter create -i objc --template=plugin hybrid_webview_flutter\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("2、在 info.flist 添加 io.flutter.embedded_views_preview: YES。PlatformView 功能默认关闭，不配置这行就没法使用\n"),e("img",{attrs:{src:a(178),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('// 注册flutter 与 ios 通信通道\nNSString* channelName = [NSString stringWithFormat:@"com.calcbit.hybridWebview_%lld", viewId];\n_channel = [FlutterMethodChannel methodChannelWithName:channelName binaryMessenger:messenger];\n__weak __typeof__(self) weakSelf = self;\n[_channel setMethodCallHandler:^(FlutterMethodCall *  call, FlutterResult  result) {\n\t[weakSelf onMethodCall:call result:result];\n}];\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("//用来创建 ios 原生view\n- (nonnull NSObject<FlutterPlatformView> *)createWithFrame:(CGRect)frame viewIdentifier:(int64_t)viewId arguments:(id _Nullable)args {\n    //args 为flutter 传过来的参数\n    Webview *webView = [[Webview alloc] initWithWithFrame:frame viewIdentifier:viewId arguments:args binaryMessenger:_messenger];\n    return webView;\n}\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('[registrar registerViewFactory:[[WebviewFactory alloc] initWithMessenger:registrar.messenger] withId:@"com.calcbit.hybridWebview"];\n')])])])},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"language-dart extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[t._v("Widget "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildWebView")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("UiKitView")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      viewType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"com.calcbit.hybridWebview"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      creationParams"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"url"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" widget"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//参数的编码方式")]),t._v("\n      creationParamsCodec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("StandardMessageCodec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//webview 创建后的回调")]),t._v("\n      onPlatformViewCreated"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建通道")]),t._v("\n        _channel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MethodChannel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.calcbit.hybridWebview_$id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//设置监听")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nativeMessageListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      gestureRecognizers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Factory"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("OneSequenceGestureRecognizer"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Factory")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("OneSequenceGestureRecognizer"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("EagerGestureRecognizer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toSet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"target-2-flutter-与-native-通信"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#target-2-flutter-与-native-通信","aria-hidden":"true"}},[this._v("#")]),this._v(" target 2: flutter 与 native 通信")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"native-调用-flutter"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#native-调用-flutter","aria-hidden":"true"}},[this._v("#")]),this._v(" native 调用 flutter")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"flutter-调用-native"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flutter-调用-native","aria-hidden":"true"}},[this._v("#")]),this._v(" flutter 调用 native")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("为了扩展性，这里将 invokeMethod 的第一个参数固定为 "),e("code",[this._v("__flutterCallJs")]),this._v("，第二个参数固定为数组，数组第一个参数固定为 js 的目标方法。这样只是用 "),e("code",[this._v("__flutterCallJs")]),this._v(" 就不用每增加一个方法就去修改 native 的代码。"),e("br"),this._v("\nNative 调 flutter 的消息名不固定是因为我们能够经常修改 flutter，但是不会经常修改 native")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('-(void)onMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result{\n    if ([[call method] isEqualToString:@"__flutterCallJs"]) {\n        NSString *action = [call.arguments firstObject];\n        NSArray *params;\n        if ([call.arguments count] > 1) {\n            params = [call.arguments subarrayWithRange:NSMakeRange(1, [call.arguments count] -1)];\n        } else {\n            params = @[];\n        }\n        //  在主线程更新 webview，不然会崩\n        dispatch_async(dispatch_get_main_queue(), ^{\n            [self->_context[@"__flutterCallJs"] callWithArguments:@[action, params, ^(JSValue *value) {\n                NSArray *arr = [value toArray];\n                result(arr);\n            }]];\n        });\n    } else if ([[call method] isEqualToString:@"evaluateJavaScript"]) {\n        // 注入 js\n        NSString* jsString = [call arguments];\n        dispatch_async(dispatch_get_main_queue(), ^{\n            [self->_webView stringByEvaluatingJavaScriptFromString:jsString];\n        });\n    }\n}\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("下图列举了 native 与 flutter 值的转换\n"),e("img",{attrs:{src:a(179),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("通过实践限制 flutter 调 oc 限制的参数为 bool, int, double, string,List, Map, Null"),e("br"),this._v("\nSet不能传会报错，map 的 key 必须为 string，不然 flutter 传给 OC 没问题，OC传给 js 的时候会剔除掉。如 {'a':1,2:2} 传到 js 就变成了 {'a':1}")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"target-3-webview-与-native-通信"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#target-3-webview-与-native-通信","aria-hidden":"true"}},[this._v("#")]),this._v(" target 3: webview 与 native 通信")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"native-调用-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#native-调用-js","aria-hidden":"true"}},[this._v("#")]),this._v(" native 调用 js")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("在 webview 定义全局函数 "),e("code",[this._v("__flutterCallJs")]),this._v(" 用来接收 OC 传递过来的值。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("JSContext 执行 "),e("code",[this._v("__flutterCallJs")]),this._v(" 透传 flutter 传过来的参数，并多传一个 block 参数，block 在 js 里会变成函数，js 侧调用这个函数类似 callback")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"js-调用-native"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#js-调用-native","aria-hidden":"true"}},[this._v("#")]),this._v(" js 调用 native")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('_context[@"globalFuction"] = ^(JSValue *value) {\n\tNSLog("%@", value);\n};\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('//定义一个JSExport protocol\n@protocol JSExportProtocol <JSExport>\n\tJSExportAs(jsCallFlutter, - (void)jsCallFlutter:(JSValue *)action params:(JSValue *)params callback:(JSValue *)callback);\n@end\n\n//将self添加到context中\n_context[@"__OCObj"] = self;\n};\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("这时候 js 全局链就会有 "),e("code",[this._v("__OCObj")]),this._v(" 对象，调用 __OCObj.jsCallFlutter 传递参数给 OC，约定 最后一个参数为 callback，js Function 到 OC 里面会转换成 block")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('#pragma mark - jsExport\n- (void)jsCallFlutter:(JSValue *)action params:(JSValue *)params callback:(JSValue *)callback {\n    NSString *actionName = [NSString stringWithFormat:@"%@", action];\n    NSArray *arr = [params toArray];\n    [self->_channel invokeMethod:actionName arguments:arr result:^(id  _Nullable result) {\n        if ([result isKindOfClass:[NSClassFromString(@"FlutterError") class]]) {\n            [callback callWithArguments:@[[result valueForKey:@"_message"], [NSNull null]]];\n        } else {\n            id results;\n            if (result) {\n                results = result;\n            } else {\n                results = [NSNull null];\n            }\n            //  在主线程更新 webview\n            dispatch_async(dispatch_get_main_queue(), ^{\n                [callback callWithArguments:@[[NSNull null], results]];\n            });\n        }\n    }];\n}\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"target-4-cookie-共享"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#target-4-cookie-共享","aria-hidden":"true"}},[this._v("#")]),this._v(" target 4: cookie 共享")])},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"language-dart extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// dio & dio_cookie_manager 代码")]),t._v("\nFuture "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("RequestOptions options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cookieJar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadForRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeWhere")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expires"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isBefore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    String cookie "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCookies")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isNotEmpty"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("HttpHeaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookieHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token metadata symbol"}},[t._v("@override")]),t._v("\n  Future "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Response response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_saveCookies")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_saveCookies")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Response response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      List"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("HttpHeaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setCookieHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cookies "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        cookieJar"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveFromResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fromSetCookieValue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("然后？"),e("br"),this._v(" "),e("img",{attrs:{src:a(180),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案","aria-hidden":"true"}},[this._v("#")]),this._v(" 方案")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("OC 与 webView 的 cookie 是互通的，不用手动处理")]),this._v(" "),e("li",[this._v("dart req/res 调用 MethodChannel 读/存 cookie")]),this._v(" "),e("li",[this._v("OC 存 cookie 至 NSHTTPCookieStorage，并同步至 webView 的 document.cookie")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h5",{attrs:{id:"实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现","aria-hidden":"true"}},[this._v("#")]),this._v(" 实现")])},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"language-dart extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" Future"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("bool"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCookie")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" String domain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" String name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" String value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int exp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    bool result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" _channel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invokeMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setCookie'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("domain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" Future"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("List"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCookie")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("String url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" List res "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" _channel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invokeMethod")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'getCookie'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    List"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" listMap "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" listMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('// 读 cookie\nNSArray *cookieArray = [NSArray arrayWithArray:[[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies]];\n\n// 存 cookie\nNSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:cookieProperties];\n[[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie];\n\n// 请求带上 cookie\nNSDictionary *cookieHeaderDic = [NSHTTPCookie requestHeaderFieldsWithCookies:[[NSHTTPCookieStorage sharedHTTPCookieStorage] cookies]];\n[request setValue:[cookieHeaderDic objectForKey:@"Cookie"] forHTTPHeaderField:@"Cookie"];\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-Objective-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v(" NSString *jsStr = [NSString stringWithFormat:@\"document.cookie='%@=%@;expires=%ld'\",name,value,exp];\n[_webView stringByEvaluatingJavaScriptFromString:jsStr];\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"实践应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实践应用","aria-hidden":"true"}},[this._v("#")]),this._v(" 实践应用")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("js 传递配置数组给 flutter，将 callback 存储在 js")]),this._v(" "),e("li",[this._v("flutter 根据配置渲染 AppBar actions，设置点击回调将按钮类型回传 js")]),this._v(" "),e("li",[this._v("js 根据 flutter 传过来的值调用之前缓存的 callback，调用结果返回给 flutter")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:a(181),alt:""}}),this._v(" "),e("img",{attrs:{src:a(182),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"写在最后"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#写在最后","aria-hidden":"true"}},[this._v("#")]),this._v(" 写在最后")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("Flutter 里跑 webview 显然不是明智的做法，flutter 官方默认都关闭 PlatformView 功能。"),e("br"),this._v("\n相对于 hybrid 和 RN 只有 JSC 通信，这里的 webview 又多了一层 flutter 通信。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:a(183),alt:""}}),e("br"),this._v(" "),e("strong",[this._v("Anyway, Keep Balance.")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h4",{attrs:{id:"题外话-作为页面仔我们做跨端的优劣势"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#题外话-作为页面仔我们做跨端的优劣势","aria-hidden":"true"}},[this._v("#")]),this._v(" 题外话 - 作为页面仔我们做跨端的优劣势")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("del",[this._v("怕被砖，先声明以下为纯扯淡内容")]),e("br"),this._v(" "),e("img",{attrs:{src:a(184),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h6",{attrs:{id:"优势"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优势","aria-hidden":"true"}},[this._v("#")]),this._v(" 优势")])},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ul",[a("li",[t._v("快，一次开发到处跑，对比安卓一堆机型一堆特殊 api，固定 webview 内核简直美滋滋")]),t._v(" "),a("li",[t._v("快，hotreload爽的不行")]),t._v(" "),a("li",[t._v("快，增量热更新绕过审核")]),t._v(" "),a("li",[t._v("快，开发体验，MVVM，声明式开发加上组件库简直拼积木，iOS 命令式开发连尾灯都看不到")]),t._v(" "),a("li",[t._v("快，CSS 牛逼，Android 还得整 xml，iOS 更是惨到手写代码布局")]),t._v(" "),a("li",[t._v("快，开发环境简单，node / web 一把梭，native 一堆奇奇怪怪的配置")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h6",{attrs:{id:"劣势"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#劣势","aria-hidden":"true"}},[this._v("#")]),this._v(" 劣势")])},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ul",[a("li",[t._v("慢，能力限制在 webview 的环境里，webview 限制了上限，扩展功能需要 native 排期施舍")]),t._v(" "),a("li",[t._v("慢，单线程，渲染还会互斥，仰仗 native 帮忙分拆逻辑线程和UI线程进行优化")]),t._v(" "),a("li",[t._v("慢，JIT 干不过 AOT")]),t._v(" "),a("li",[t._v("慢，渲染干不过 native，多了层中间商 webview 赚差价，无限列表 webview 连 native 的尾灯都看不到\n"),a("ul",[a("li",[t._v("native 渲染: view -> layout -> renderNode -> 合成 -> GPU渲染")]),t._v(" "),a("li",[t._v("webview: html -> dom tree -> render tree -> render layer -> 合成 -> gpu渲染")])])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("PS: 听说 flutter 很强，但它并不是前端专属玩具，因为 native 上手更有优势（尤其 Android）"),e("br"),this._v(" "),e("img",{attrs:{src:a(185),alt:""}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("综上，"),e("em",[e("strong",[this._v("快")])]),this._v(" 才是我们的优势啊，钻牛角尖跟 native 比性能，何必呢。"),e("br"),this._v(" "),e("img",{attrs:{src:a(186),alt:""}})])}],n=a(0),r=Object(n.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/wayshon/hybrid_webview_flutter",target:"_blank",rel:"noopener noreferrer"}},[t._v("github地址"),a("OutboundLink")],1)]),t._v(" "),t._m(1),t._v(" "),a("p",[t._v("Flutter 是一个 UI 框架，实际开发中除了常见的 widget 还需要如地图、webview等 Native 组件。")]),t._v(" "),a("p",[t._v("一种方法是 Flutter 通知 Native 唤起 Native 界面，如之前的"),a("a",{attrs:{href:"https://github.com/wayshon/scan_flutter_ios",target:"_blank",rel:"noopener noreferrer"}},[t._v("扫码插件"),a("OutboundLink")],1),t._v("。缺点是 Native 组件很难和 Flutter 组件进行组合。")]),t._v(" "),a("p",[t._v("第二种是通过 Flutter 提供的 PlatformView(AndroidView/UIKitView) 将 Native 组件嵌入到 Flutter的组件树。使 Flutter 能够像控制普通 widget 那样控制 Native 组件。")]),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("1、创建插件:")]),t._v(" "),t._m(7),a("p",[t._v("自动生成 HybridWebviewFlutterPlugin 类，打开 Runner.xcworkspace")]),t._v(" "),t._m(8),t._v(" "),a("p",[t._v("3、创建 webview 类，实现 FlutterPlatformView 协议，在构造函数里获取 flutter 传递过来的参数，创建 webview，创建 FlutterMethodChannel 并设置 block 回调。")]),t._v(" "),t._m(9),a("p",[t._v("4、创建工厂类 WebviewFactory，实现 FlutterPlatformViewFactory 协议，实现协议中的 createWithFrame 方法并返回步骤3创建的 webview")]),t._v(" "),t._m(10),a("p",[t._v("5、步骤1生成的 HybridWebviewFlutterPlugin 注册插件的方法 registerWithRegistrar 中添加一行注册 WebviewFactory")]),t._v(" "),t._m(11),a("p",[t._v("6、根目录 lib/ 下新建 hybrid_webview.dart 文件，创建 HybridWebview Widget，build 返回 UiKitView。UiKitView 接收的 viewType 与步骤5注册 Factory 时的 withId 一致。")]),t._v(" "),a("p",[t._v("creationParams 可传递参数给步骤3。")]),t._v(" "),a("p",[t._v("creationParamsCodec 标准平台通道使用标准消息编解码器，以支持简单的类似JSON值的高效二进制序列化 参考"),a("a",{attrs:{href:"https://api.flutter.dev/flutter/services/StandardMessageCodec-class.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("StandardMessageCodec"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("onPlatformViewCreated 在 UiKitView 创建完成后执行，可获取到 Native 组件的 viewId，注册 MethodChannel，这时候 channel 可与步骤3创建的 webview 进行通信")]),t._v(" "),t._m(12),t._m(13),t._v(" "),t._m(14),t._v(" "),a("p",[t._v("target 1 步骤3 创建的 FlutterMethodChannel channel 可以调用 invokeMethod 方法传递消息名，参数给 flutter，并设置 flutter 回调")]),t._v(" "),a("p",[t._v("回调参数 result 可能是 flutter Feature 返回值，也有可能是 flutter 运行时报错")]),t._v(" "),t._m(15),t._v(" "),a("p",[t._v("有了 target 1 步骤 6 onPlatformViewCreated 里创建的 channel，使用 channel.invokeMethod 调用 native 方法，第一个参数为消息名，第二个为可选参数。返回一个 Future（类似 js 的 Promise）")]),t._v(" "),a("p",[t._v("在 target 1 步骤 3 OC 创建 FlutterMethodChannel 时的 block 可接收到 flutter 的调用信息。第一个参数 FlutterMethodCall 包含了 flutter 调用的消息名与参数，第二个参数 FlutterResult 是一个回调函数，传递给 flutter 返回值。")]),t._v(" "),t._m(16),t._v(" "),t._m(17),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),a("p",[t._v("在 target 2 中 OC 已经能够接收到 flutter 传递过来的消息，这时候 OC 需要将消息传给 js。可以通过 KVC 获取到 UIWebView 的 JSContext（WKWebView取不到context但是可以通过消息形式）")]),t._v(" "),t._m(22),t._v(" "),t._m(23),t._v(" "),a("p",[t._v("OC 的 block 接收到 js 执行的回调，调用 FlutterResult，将回调结果返回给 flutter")]),t._v(" "),a("p",[t._v("除了获取 js context 执行 js，webview 常见的还有注入 js，可以接收 flutter 传来的 js string 注入到 webview")]),t._v(" "),t._m(24),t._v(" "),a("p",[t._v("1、JSContext 直接注入 bolck，js 调用这个函数")]),t._v(" "),t._m(25),a("p",[t._v("2、通过 JSExport 协议，只有 JSExport 里声明的方法才会被 js 访问到")]),t._v(" "),a("p",[t._v("定义一个 JSExport 协议，并在 Class A 实现，将 A 实例化并作为全局变量注入到 JSContext，这里为了方便直接在 webview 定义实现 JSExport，将 当期实例 self 注入到 JSContext")]),t._v(" "),t._m(26),t._m(27),t._v(" "),a("p",[t._v("OC 通过 FlutterMethodChannel 调用 flutter 获得返回值后通过这个 block 触发 js 的 callback")]),t._v(" "),t._m(28),a("p",[t._v("经实践，限制 js 传给 OC 的值为 boolean, number, string, array, obj, null/undefined")]),t._v(" "),a("p",[t._v("null/undefined 都会转成 null，fn/set/map都会在OC变成空字典 {}，{1: 'a'} 到了 OC key 也会转成 string")]),t._v(" "),t._m(29),t._v(" "),a("p",[t._v("webView/OC，RN/OC cookie 都是共享的。但是 flutter 比较奇怪，用过的 dart:io 与 "),a("a",{attrs:{href:"https://pub.flutter-io.cn/packages/dio",target:"_blank",rel:"noopener noreferrer"}},[t._v("dio"),a("OutboundLink")],1),t._v(" 都不自动带上cookie，查看了 "),a("a",{attrs:{href:"https://pub.flutter-io.cn/packages/dio_cookie_manager",target:"_blank",rel:"noopener noreferrer"}},[t._v("dio_cookie_manager"),a("OutboundLink")],1),t._v(" 与 "),a("a",{attrs:{href:"https://pub.flutter-io.cn/packages/cookie_jar",target:"_blank",rel:"noopener noreferrer"}},[t._v("cookie_jar"),a("OutboundLink")],1),t._v(" 的实现，发现 dio 是利用这两个库自己在 dart 维护了 cookie 信息，然后添加到 dio.interceptors 里，随 request 带上，监听 response 存储。")]),t._v(" "),t._m(30),a("p",[t._v("由于这种实现相当于把 response 的 cookie 维护在 dart 层面，所以 OC 的请求就不会有这些信息，webView 环境也不会有。")]),t._v(" "),t._m(31),t._v(" "),a("p",[t._v("与其将 cookie 信息维护在 dart，为什么不直接维护在 OC，那样OC/webView的请求还能带上。")]),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),a("p",[t._v("1、 dart 存取 cookie 存到 OC")]),t._v(" "),t._m(35),a("p",[t._v("2、OC 存取 dart 传过来的值，并在 OC 发送请求时带上这些 cookie")]),t._v(" "),t._m(36),a("p",[t._v("3、OC 接收到 dart 传过来的 cookie 时顺带将 cookie 写入 webView")]),t._v(" "),t._m(37),t._m(38),t._v(" "),a("p",[t._v("WebView 控制 flutter 导航栏右侧 BarButtonItem")]),t._v(" "),t._m(39),t._v(" "),t._m(40),t._v(" "),t._m(41),t._v(" "),t._m(42),t._v(" "),a("p",[t._v("但是特殊场景下也不是不可以这么玩。类似在 RN / 小程序 里跑webview，在小程序里套 webview 减小包体积，避开审核快速迭代的做法不在少数。")]),t._v(" "),a("p",[t._v("也有在微信小程序里利用 miniprograme.navigateTo 触发app.pageNotFound 做 IOC 的，虽然慢了点绕了点，但是提高了开发效率与迭代速度。")]),t._v(" "),t._m(43),t._v(" "),t._m(44),t._v(" "),t._m(45),t._v(" "),t._m(46),t._v(" "),t._m(47),t._v(" "),t._m(48),t._v(" "),t._m(49),t._v(" "),t._m(50),t._v(" "),t._m(51)])},s,!1,null,null,null);e.default=r.exports}}]);